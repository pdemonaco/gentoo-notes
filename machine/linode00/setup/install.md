# Configure Portage

1. Copy in a good make.conf file to start. 
2. Once it's in place, configure the values generated by the following command as parameters to `CPU_FLAGS_X86`.

    ```bash
    emerge -1v app-portage/cpuid2cpuflags
    cpuid2cpuflags
    ```
4. With those changes in place, sync an updated copy of the portage tree and re-merge with current config.

    ```bash
    emerge --sync
    emerge -avtuDNn --with-bdeps=y world
    ```

5. Clear out eselect news...

    ```bash
    eselect news read
    eselect news purge
    ```

6. Collect some good mirrors and add the updated record to make.conf.

    ```bash
    emerge -1av mirrorselect
    mirrorselect -D -s4 -b10 -o >> /tmp/mirrors
    ```
    
    Note that this linode just uses [rit](http://mirrors.rit.edu/genoto/).

## Git based Portage 

Switch to git-based portage tree for gentoo.

1. Ensure git is installed somehow (hint `which git`)
2. Emerge it if it's not installed.

    ```bash
    # Probably won't need to do this
    mkdir etc/portage/repos.conf
    cp usr/share/portage/config/repos.conf etc/portage/repos.conf/gentoo.conf
    ```

3. Modify the new gentoo.conf to reflect this change

    ```ini
    [DEFAULT]
    main-repo = gentoo

    [gentoo]
    location = /usr/portage
    sync-type = git
    sync-uri = https://github.com/gentoo-mirror/gentoo.git
    auto-sync = yes
    ```
2. Move the existing distfiles directory up for a moment.

    ```bash
    mv /usr/portage/distfiles /usr/
    ```

3. Clear out the existing portage tree

    ```bash
    cd /usr/portage
    rm -r ./*
    emerge --sync
    ```
4. Put the distfiles back.

    ```bash
    mv /usr/distfiles /usr/portage/
    ```

## Configure Sets

1. Sync over the latest copies of my sets.
2. Move them from /tmp to /etc/portage/sets/

    ```bash
    mkdir /etc/portage/sets/
    mv /tmp/tools-* /etc/portage/sets/
    mv /tmp/fonts /etc/portage/sets/
    cd /etc
    git add /etc/portage/sets/*
    git commit
    ```
3. Emerge various tool sets.

    ```bash
    emerge -avtn @tools-admin @tools-net @tools-perf @tools-portage @tools-shell
    ```

# Base configuration

1. Definitely mix in steps from chapters 5-6 of the handbook here, but first
install vim - don't be a savage.

    ```bash
    emerge -avtn app-editors/vim
    ```

2. Once we have vim we need it to be the default editor for our system.

    ```bash
    eselect editor list
    eselect editor set 3
    . /etc/profile
    ```
    ![Setting the editor](img/editor-select.png)

## Git Tracking for /etc

1. Initialize the repository in etc.

    ```bash
    cd /etc
    git init
    git config --global user.email "you@example.com"
    git config --global user.name "Your Name"
    ```
2. Create a new repo on https://gitlab.com or similar to actually retain the config.
3. Configure a key if it's not already existing. 
4. Push the changes up via `git push -u origin master`.

## System Configuration

Finalization steps prior to being able to reboot into the new environment.

### fstab

No changes are needed for this system.

### Networking

#### Host and Domain Names

1. Something basic for base install

    ```bash
    cd /etc
    vim conf.d/hostname
    git add conf.d/hostname
    ```

2. Store full hostnames in case DNS is down

    ```bash
    cd /etc
    vim hosts
    git add hosts
    ```

    ![Modified hosts](img/hosts.png)

3. Leave the dns domain alone for the moment. It doesn't really matter.

### Initial Setup

#### Root Password

This should already be set. 

#### Logging

Metalog for the moment because its fancy, quick, and easy to setup

1. Install it and add it to the default runlevel.

    ```bash
    emerge -vt app-admin/metalog
    eselect rc add metalog default
    eselect rc start metalog
    ```
2. Add the config file to git.

    ```bash
    cd /etc
    git add /etc/metalog.conf
    git commit
    ```

#### Cron

We'll also need to get a cron going. I like fcron.

1. Install the base package.

    ```bash
    emerge -vt sys-process/fcron
    eselect rc add fcron default
    eselect rc start fcron
    crontab /etc/crontab
    ```

#### Local User

Definitely a must have for any system. 

1. We'll need to create ourself, and add to the appropriate groups.

    ```bash
    USER="phil"
    GROUPS="users,wheel"
    useradd -m -G "${GROUPS}" -s /bin/zsh "${USER}"
    passwd "${USER}"
    ```
2. Create any other necessary users.

#### Sudo

1. Open the configuration file.

    ```bash
    visudo
    ```
2. Uncomment the "wheel" rule.

    ![Uncomment this line](img/visudo-wheel.png)

